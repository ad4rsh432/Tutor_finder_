{% extends 'base.html' %}
{% load static %}
{% block title %}My Profile - TutorFinder{% endblock %}

{% block content %}
<div class="page-header mb-5">
    <div class="container text-center text-md-start">
        <div class="d-flex align-items-center gap-4 flex-column flex-md-row">
            <div class="position-relative">
                {% if profile.profile_picture %}
                <img src="{{ profile.profile_picture.url }}" class="avatar-xl border-4 shadow-lg" alt="Profile"
                    style="width: 150px; height: 150px;">
                {% else %}
                <div class="avatar-xl bg-white bg-opacity-20 d-flex align-items-center justify-content-center border-4 shadow-lg"
                    style="width: 150px; height: 150px;">
                    <i class="bi bi-person text-white fs-1"></i>
                </div>
                {% endif %}
                <button class="btn btn-sm btn-light rounded-circle position-absolute bottom-0 end-0 shadow-sm"
                    style="width: 35px; height: 35px; border: 2px solid var(--accent);"
                    onclick="document.getElementById('id_profile_picture').click();">
                    <i class="bi bi-camera-fill text-primary"></i>
                </button>
            </div>
            <div>
                <h1 class="hero-title mb-1 text-white">
                    {{ profile.full_name|default:user.username }}
                </h1>
                <p class="mb-0 opacity-75 text-white lead">
                    <i class="bi bi-geo-alt me-2"></i>
                    {{ profile.location|default:"Location not set" }}
                </p>
                <div class="mt-3 d-flex flex-wrap gap-2">
                    <span class="badge badge-accent-soft px-3 py-2 text-dark fw-bold">STUDENT</span>
                    <span
                        class="badge bg-white bg-opacity-10 px-3 py-2 text-white border border-white border-opacity-25">
                        {{ profile.age|default:"--" }} Years Old
                    </span>
                </div>
            </div>
        </div>
    </div>
</div>

<div class="container pb-5">
    <div class="row g-4">
        <div class="col-lg-3">
            <div class="custom-card p-3 sticky-top" style="top: 100px;">
                <div class="nav flex-column nav-pills" id="v-pills-tab" role="tablist">
                    <button class="nav-link active text-start py-3 px-4 mb-2 d-flex align-items-center gap-3"
                        id="edit-profile-tab" data-bs-toggle="pill" data-bs-target="#edit-profile" type="button"
                        role="tab">
                        <i class="bi bi-person-bounding-box fs-5"></i>
                        <span>Edit Profile</span>
                    </button>
                    <button class="nav-link text-start py-3 px-4 mb-2 d-flex align-items-center gap-3"
                        id="interests-tab" data-bs-toggle="pill" data-bs-target="#interests" type="button" role="tab">
                        <i class="bi bi-star fs-5"></i>
                        <span>Interests</span>
                    </button>
                    <button class="nav-link text-start py-3 px-4 mb-2 d-flex align-items-center gap-3" id="account-tab"
                        data-bs-toggle="pill" data-bs-target="#account" type="button" role="tab">
                        <i class="bi bi-shield-lock fs-5"></i>
                        <span>Security</span>
                    </button>
                    <hr class="my-3 mx-3 opacity-10">
                    <a href="{% url 'student_dashboard' %}"
                        class="nav-link text-start py-3 px-4 d-flex align-items-center gap-3 text-muted">
                        <i class="bi bi-arrow-left fs-5"></i>
                        <span>Dashboard</span>
                    </a>
                </div>
            </div>
        </div>

        <div class="col-lg-9">
            <div class="tab-content" id="v-pills-tabContent">
                <div class="tab-pane fade show active" id="edit-profile" role="tabpanel">
                    <div class="custom-card p-4 p-md-5 border-0 shadow-sm">
                        <h4 class="fw-bold mb-4 pb-2 border-bottom">Personal Information</h4>
                        <form method="POST" enctype="multipart/form-data">
                            {% csrf_token %}
                            <input type="file" name="profile_picture" id="id_profile_picture" class="d-none">
                            <div class="row g-4">
                                <div class="col-md-6">
                                    <label class="form-label">Full Name</label>
                                    <input type="text" name="full_name" class="form-control"
                                        value="{{ profile.full_name }}">
                                </div>
                                <div class="col-md-6">
                                    <label class="form-label">Phone</label>
                                    <input type="text" name="phone_number" class="form-control"
                                        value="{{ profile.phone_number }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Birth Date</label>
                                    <input type="date" name="date_of_birth" class="form-control"
                                        value="{{ profile.date_of_birth|date:'Y-m-d' }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">Age</label>
                                    <input type="number" name="age" class="form-control" value="{{ profile.age }}">
                                </div>
                                <div class="col-md-4">
                                    <label class="form-label">City</label>
                                    <input type="text" name="location" class="form-control"
                                        value="{{ profile.location }}">
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Bio</label>
                                    <textarea name="bio" class="form-control" rows="4">{{ profile.bio }}</textarea>
                                </div>
                                <div class="col-12">
                                    <label class="form-label">Address</label>
                                    <textarea name="address" class="form-control"
                                        rows="2">{{ profile.address }}</textarea>
                                </div>
                                <!-- Hidden subjects to prevent clearing them when saving basic info -->
                                <select name="subjects_interested" multiple class="d-none">
                                    {% for sid in interested_ids %}
                                    <option value="{{ sid }}" selected></option>
                                    {% endfor %}
                                </select>
                                <div class="col-12 pt-4 border-top text-end">
                                    <button type="submit" class="btn btn-primary-custom px-5 py-2">Save Profile</button>
                                </div>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="tab-pane fade" id="interests" role="tabpanel">
                    <div class="custom-card p-4 p-md-5 border-0 shadow-sm">
                        <h4 class="fw-bold mb-4 pb-2 border-bottom">Learning Interests</h4>
                        <form method="POST">
                            {% csrf_token %}
                            <input type="hidden" name="full_name" value="{{ profile.full_name }}">
                            <div class="row g-3">
                                <select name="subjects_interested" class="d-none" multiple id="subject-select">
                                    {% for s in all_subjects %}
                                    <option value="{{ s.id }}" {% if s.id in interested_ids %}selected{% endif %}>{{ s.name }}</option>
                                    {% endfor %}
                                </select>
                                {% for s in all_subjects %}
                                <div class="col-md-4">
                                    <div class="subject-card p-3 border rounded-3 text-center transition-all cursor-pointer {% if s.id in interested_ids %}active{% endif %}"
                                        onclick="toggleS({{ s.id }}, this)">
                                        <span class="fw-bold">{{ s.name }}</span>
                                    </div>
                                </div>
                                {% endfor %}
                            </div>
                            <div class="col-12 pt-4 border-top text-end mt-4">
                                <button type="submit" class="btn btn-primary-custom px-5 py-2">Update Interests</button>
                            </div>
                        </form>
                    </div>
                </div>

                <div class="tab-pane fade" id="account" role="tabpanel">
                    <div class="custom-card p-4 p-md-5 border-0 shadow-sm">
                        <h4 class="fw-bold mb-4 pb-2 border-bottom">Account Security</h4>
                        <div class="alert bg-light border p-4">
                            <h6 class="fw-bold">Password Reset</h6>
                            <p class="small text-muted">Use the standard Django login pages to manage security.</p>
                            <button class="btn btn-outline-danger btn-sm mt-3">Deactivate Account</button>
                        </div>
                    </div>
                </div>
            </div>
        </div>
    </div>
</div>

<style>
    .nav-pills .nav-link.active {
        background: var(--primary);
        color: white;
    }

    .subject-card:hover {
        border-color: var(--primary) !important;
        background: var(--primary-xlight);
    }

    .subject-card.active {
        border-color: var(--primary) !important;
        background: var(--primary);
        color: white;
    }

    .cursor-pointer {
        cursor: pointer;
    }
</style>

<script>
    function toggleS(id, el) {
        const sel = document.getElementById('subject-select');
        const opt = [...sel.options].find(o => o.value == id);
        if (opt.selected) { opt.selected = false; el.classList.remove('active'); }
        else { opt.selected = true; el.classList.add('active'); }
    }
</script>
{% endblock %}
